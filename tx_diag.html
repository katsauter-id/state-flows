<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Flowchart Diagnostic</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
  body{font-family:Tahoma,Arial,sans-serif;background:#fafafa;color:#111;margin:16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1 1 520px;min-width:320px}
  textarea{width:100%;height:220px;font-family:ui-monospace,Consolas,monospace}
  pre{background:#f3f4f6;padding:12px;border-radius:8px;overflow:auto}
  #chart svg{width:100% !important;height:auto !important}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .error{white-space:pre-wrap;color:#b00020}
  button{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
  button:hover{background:#f8f9fa}
</style>
</head>
<body>
<h1>Flowchart Diagnostic</h1>

<div class="row">
  <div class="col card">
    <h3>1) Static Mermaid (sanity check)</h3>
    <button id="btnStatic">Render Static</button>
    <pre id="staticMermaid">flowchart TB;
A[Open InsCipher Connect];
B[Start New Filing (select TX)];
A --> B;</pre>
  </div>

  <div class="col card">
    <h3>2) YAML (edit or use your TX)</h3>
    <div style="margin-bottom:8px">
      YAML URL: <input id="yamlUrl" style="width:60%" value="./states/TX.yaml">
      <button id="btnYaml">Fetch + Render YAML</button>
    </div>
    <textarea id="yamlBox" placeholder="(YAML will appear here when you click 'Fetch')"></textarea>
  </div>
</div>

<div class="row" style="margin-top:16px">
  <div class="col card">
    <h3>Mermaid Source (what we send to Mermaid)</h3>
    <pre id="merSrc"></pre>
  </div>
  <div class="col card">
    <h3>Chart</h3>
    <div id="chart">Waiting…</div>
    <div id="err" class="error"></div>
  </div>
</div>

<script>
  // Clean, safe builder with bulletproof separators (semicolons) and hard newlines.
  function buildMermaidFromYaml(yamlText){
    const data = jsyaml.load(yamlText);
    const byLane = {};
    (data.steps || []).forEach(s => { (byLane[s.lane || 'default'] ||= []).push(s); });

    const laneTitle = k => ({ connect:"InsCipher Connect", state_portal:"State Portal" }[k] || k);
    const dir = data.direction || 'TB';
    const L = [];
    L.push(`flowchart ${dir}`);

    // nodes
    for (const [lane, steps] of Object.entries(byLane)) {
      const laneId = (lane||'default').toUpperCase();
      L.push(`  subgraph ${laneId}[${laneTitle(lane)}];`);
      steps.forEach(s => {
        const label = String(s.label || s.id)
          .replace(/\r?\n/g,' ')        // FORCE single-line labels for now
          .replace(/<br\s*\/?>/gi,' ')
          .replace(/\[/g,'(').replace(/\]/g,')')
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .trim();
        const node = s.type === 'decision' ? `${s.id}{${label}}` : `${s.id}[${label}]`;
        L.push(`    ${node};`);
      });
      L.push('  end;');
      L.push(''); // explicit blank line
    }

    // edges
    (data.steps || []).forEach(s=>{
      if (s.type === 'decision') {
        if (s.yes_to) L.push(`  ${s.id} -- Yes --> ${s.yes_to};`);
        if (s.no_to)  L.push(`  ${s.id} -- No --> ${s.no_to};`);
      } else if (s.next) {
        L.push(`  ${s.id} --> ${s.next};`);
      }
    });

    // simple styles (no fonts to avoid parser quirks)
    L.push(
      'style CONNECT fill:#f8f9fa,stroke:#4f46e5,stroke-width:1.5px;',
      'style STATE_PORTAL fill:#f8f9fa,stroke:#468c98,stroke-width:1.5px;',
      'classDef action fill:#ffffff,stroke:#4f46e5,stroke-width:1.5px,color:#111827;',
      'classDef decision fill:#fff7ed,stroke:#f04f23,stroke-width:2px,color:#111827;',
      'linkStyle default stroke:#616161,stroke-width:1.5px,opacity:0.9;'
    );
    (data.steps || []).forEach(s=>{
      L.push(`class ${s.id} ${s.type === 'decision' ? 'decision':'action'};`);
    });

    // join with hard newlines so nothing can end up on the same line
    return L.join('\n') + '\n';
  }

  function renderMermaid(mer){
    document.getElementById('err').textContent = '';
    document.getElementById('merSrc').textContent = mer;
    mermaid.initialize({
      startOnLoad:false, theme:"base",
      flowchart:{ useMaxWidth:true, curve:"linear", padding:12, htmlLabels:false }
    });
    return mermaid.render('diag', mer).then(({svg})=>{
      document.getElementById('chart').innerHTML = svg;
    }).catch(e=>{
      document.getElementById('chart').innerHTML = '';
      document.getElementById('err').textContent = 'Mermaid parse error:\n' + (e?.str || e?.message || e);
    });
  }

  // Buttons
  document.getElementById('btnStatic').onclick = async ()=>{
    const mer = `flowchart TB;
A[Open InsCipher Connect];
B[Start New Filing (select TX)];
A --> B;`;
    await renderMermaid(mer);
  };

  document.getElementById('btnYaml').onclick = async ()=>{
    const url = document.getElementById('yamlUrl').value.trim();
    document.getElementById('err').textContent = '';
    document.getElementById('chart').textContent = 'Loading…';
    try{
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
      const y = await res.text();
      document.getElementById('yamlBox').value = y;
      const mer = buildMermaidFromYaml(y);
      await renderMermaid(mer);
    } catch(e){
      document.getElementById('chart').textContent = '';
      document.getElementById('err').textContent = e.message;
    }
  };
</script>
</body>
</html>
