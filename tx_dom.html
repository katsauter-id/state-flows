<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>TX Flow (DOM-fed, Mermaid 9.4.3)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- YAML + Mermaid (pinned to stable 9.4.3) -->
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@9.4.3/dist/mermaid.min.js"></script>

<style>
  body{font-family:Tahoma,Arial,sans-serif;margin:16px;background:#fafafa;color:#111}
  #chart .mermaid{white-space:pre;} /* preserve newlines exactly */
  .err{white-space:pre-wrap;color:#b00020;margin-top:12px}
  pre{background:#f3f4f6;padding:12px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
<h1>TX Flow (DOM-fed, Mermaid 9.4.3)</h1>
<div>Source: <span id="src"></span></div>

<div id="chart"><div id="m" class="mermaid">Loadingâ€¦</div></div>

<h3>Mermaid Source</h3>
<pre id="merSrc"></pre>

<div id="err" class="err"></div>

<script>
const qs = new URL(location.href).searchParams;
const yamlUrl = qs.get('yaml') || './states/TX.yaml';
document.getElementById('src').textContent = yamlUrl;

// one-line labels for stability; we can add multi-line later
function sanitizeLabel(txt){
  return String(txt || '')
    .replace(/\r?\n/g,' ')
    .replace(/<br\s*\/?>/gi,' ')
    .replace(/\[/g,'(').replace(/\]/g,')')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .trim();
}

function buildMermaid(data){
  const L = [];
  L.push('flowchart TB'); // vertical layout
  // nodes (each on its own line, with semicolon)
  (data.steps || []).forEach(s=>{
    const label = sanitizeLabel(s.label || s.id);
    const node  = s.type === 'decision' ? `${s.id}{${label}}` : `${s.id}[${label}]`;
    L.push(node + ';');
  });
  // edges
  (data.steps || []).forEach(s=>{
    if (s.type === 'decision') {
      if (s.yes_to) L.push(`${s.id} -- Yes --> ${s.yes_to};`);
      if (s.no_to)  L.push(`${s.id} -- No --> ${s.no_to};`);
    } else if (s.next) {
      L.push(`${s.id} --> ${s.next};`);
    }
  });
  return L.join('\n');
}

(async function main(){
  try{
    const res = await fetch(yamlUrl, { cache:'no-store' });
    if(!res.ok) throw new Error(`Fetch failed (${res.status}) for ${yamlUrl}`);
    const raw = await res.text();
    const data = jsyaml.load(raw);

    const mer = buildMermaid(data);
    document.getElementById('merSrc').textContent = mer;

    // Reset target element and feed graph text directly
    const el = document.getElementById('m');
    el.className = 'mermaid';
    el.removeAttribute('data-processed');
    el.textContent = mer;

    // Init + render with Mermaid 9.x
    mermaid.initialize({ startOnLoad:false, theme:'default' });
    mermaid.init(undefined, el);

  } catch(e){
    document.getElementById('err').textContent = (e?.message || e);
    console.error(e);
  }
})();
</script>
</body>
</html>
