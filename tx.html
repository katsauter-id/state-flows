<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Texas Filing Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root { --card:#fff; --ink:#111; --muted:#666; --border:#e5e7eb; }
    html,body { margin:0; padding:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; font-weight: 600; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    #chart svg { width: 100% !important; height: auto !important; }
    .foot { margin-top:10px; color:var(--muted); font-size: .85rem; }
    .error { color:#b00020; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Texas Filing Flow</h1>
    <div id="chart" class="card">Loadingâ€¦</div>
    <div class="foot">Source: <span id="src"></span></div>
  </div>

  <script>
    // Tiny helper: read ?yaml=/states/TX.yaml (defaults to ./states/TX.yaml)
    function yamlUrlFromQuery() {
      const u = new URL(location.href);
      return u.searchParams.get('yaml') || './states/TX.yaml';
    }

    // YAML -> Mermaid adapter (lanes + steps + edges)
   function toMermaid(data) {
  const byLane = {};
  (data.steps || []).forEach(s => {
    const lane = s.lane || s.lane_key || 'default';
    (byLane[lane] ||= []).push(s);
  });

  const laneTitle = k => ({ connect: "InsCipher Connect", state_portal: "State Portal" }[k] || k);
  const dir = data.direction || 'LR'; // use "TB" for vertical
  const lines = [`flowchart ${dir}`];

  // lanes & nodes
  for (const [lane, steps] of Object.entries(byLane)) {
    const laneId = lane.toUpperCase(); // CONNECT / STATE_PORTAL
    lines.push(`  subgraph ${laneId}[${laneTitle(lane)}]`);
    for (const s of steps) {
      const label = (s.label || s.id).replace(/\[/g,'(').replace(/\]/g,')');
      const node = s.type === 'decision' ? `${s.id}{${label}}` : `${s.id}[${label}]`;
      lines.push(`    ${node}`);
    }
    lines.push('  end');
  }

  // edges
  for (const s of (data.steps || [])) {
    if (s.type === 'decision') {
      if (s.yes_to) lines.push(`  ${s.id} -- Yes --> ${s.yes_to}`);
      if (s.no_to)  lines.push(`  ${s.id} -- No --> ${s.no_to}`);
    } else if (s.next) {
      lines.push(`  ${s.id} --> ${s.next}`);
    }
  }

  // === InsCipher styling ===
  lines.push(
    // lane backgrounds & borders
    'style CONNECT fill:#eef2ff,stroke:#009ddc,stroke-width:1.5px',
    'style STATE_PORTAL fill:#ecfeff,stroke:#468c98,stroke-width:1.5px',

    // node classes (Tahoma + brand colors)
    'classDef action   fill:#ffffff,stroke:#009ddc,stroke-width:1.5px,color:#373f51,font-family:Tahoma',
    'classDef decision fill:#fff7ed,stroke:#f04f23,stroke-width:2px,color:#373f51,font-family:Tahoma',

    // link styling
    'linkStyle default stroke:#616161,stroke-width:1.5px,opacity:0.9'
  );

  // apply classes per node type
  (data.steps || []).forEach(s => {
    const cls = s.type === 'decision' ? 'decision' : 'action';
    lines.push(`class ${s.id} ${cls}`);
  });

  return lines.join('\n');
}

    }

    async function main() {
      const yamlUrl = yamlUrlFromQuery();
      document.getElementById('src').textContent = yamlUrl;

      const res = await fetch(yamlUrl, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${yamlUrl}`);
      const text = await res.text();

      let data;
      try { data = jsyaml.load(text); }
      catch (e) { throw new Error('YAML parse error: ' + e.message); }

      const mer = toMermaid(data);
      mermaid.initialize({ startOnLoad: false });
      const { svg } = await mermaid.render('diagram', mer);
      document.getElementById('chart').innerHTML = svg;
    }

    main().catch(err => {
      const c = document.getElementById('chart');
      c.className = 'card error';
      c.textContent = 'Error loading diagram: ' + err.message;
    });
  </script>
</body>
</html>
