<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>State Filing Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root { --ink:#373f51; --muted:#616161; --border:#e5e7eb; --card:#fff; }
    html,body{margin:0;padding:0}
    body{font-family: Tahoma, Arial, sans-serif; color:var(--ink); background:#fafafa}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:1.25rem;margin:0 0 12px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    #chart svg{width:100% !important;height:auto !important}
    .foot{margin-top:8px;color:var(--muted);font-size:.85rem}
    .error{color:#b00020;white-space:pre-wrap}
    a{color:#4f46e5;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">Filing Flow</h1>
    <div id="chart" class="card">Loadingâ€¦</div>
    <div class="foot">Source: <span id="src"></span></div>
  </div>

<script>
  // Simple logger that writes to the page
  function say(msg) {
    const c = document.getElementById('chart');
    c.textContent = (c.textContent || '') + '\n' + msg;
  }

  async function main(){
    try {
      say('ðŸ”„ Initializingâ€¦');

      const qs = new URL(location.href).searchParams;
      const yamlUrl = qs.get('yaml') || './states/TX.yaml';
      document.getElementById('src').textContent = yamlUrl;

      say('â¬‡ï¸ Fetching YAML: ' + yamlUrl);
      const res = await fetch(yamlUrl, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${yamlUrl}`);

      const raw = await res.text();
      say('âœ… YAML fetched, parsingâ€¦');

      let data;
      try { data = jsyaml.load(raw); }
      catch(e){ throw new Error('YAML parse error: ' + e.message); }

      say('âœ… YAML parsed, building diagramâ€¦');

      // build mermaid text
      const mer = toMermaid(data);

      // render
      say('ðŸ§­ Rendering with Mermaidâ€¦');
      mermaid.initialize({
        startOnLoad: false,
        theme: "base",
        flowchart: { useMaxWidth:true, curve:"linear", padding:12, htmlLabels:true },
        themeVariables: {
          fontFamily: 'Tahoma, Arial, sans-serif',
          primaryColor: '#ffffff',
          primaryTextColor: '#373f51',
          primaryBorderColor: '#4f46e5',
          lineColor: '#616161',
          tertiaryColor: '#f04f23'
        }
      });

      const out = await mermaid.render('diagram', mer);
      document.getElementById('chart').innerHTML = out.svg;
      say('ðŸ Done.');
    } catch (err) {
      const c = document.getElementById('chart');
      c.className = 'card error';
      c.textContent = 'Error loading diagram:\n' + err.message;
      console.error(err);
    }
  }

  // show any unexpected errors
  window.addEventListener('error', e => {
    const c = document.getElementById('chart');
    c.className = 'card error';
    c.textContent = 'Unhandled error:\n' + (e.error?.message || e.message);
  });

  main();
</script>


    // YAML -> Mermaid
    function toMermaid(data) {
      const byLane = {};
      (data.steps || []).forEach(s => {
        const lane = s.lane || s.lane_key || 'default';
        (byLane[lane] ||= []).push(s);
      });
      const laneTitle = k => ({ connect:"InsCipher Connect", state_portal:"State Portal" }[k] || k);
      const dir = data.direction || 'LR';
      const lines = [`flowchart ${dir}`];

      for (const [lane, steps] of Object.entries(byLane)) {
        const laneId = lane.toUpperCase();
        lines.push(`  subgraph ${laneId}[${laneTitle(lane)}]`);
        for (const s of steps) {
          const label = (s.label || s.id)
          .replace(/\[/g, '(')           // avoid bracket collisions
          .replace(/\]/g, ')')
          .replace(/&/g, '&amp;')        // escape HTML entities
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\n/g, '<br/>');      // allow line breaks

          const node = s.type === 'decision' ? `${s.id}{${label}}` : `${s.id}[${label}]`;
          lines.push(`    ${node}`);
        }
        lines.push('  end');
      }

      for (const s of (data.steps || [])) {
        if (s.type === 'decision') {
          if (s.yes_to) lines.push(`  ${s.id} -- Yes --> ${s.yes_to}`);
          if (s.no_to)  lines.push(`  ${s.id} -- No --> ${s.no_to}`);
        } else if (s.next) {
          lines.push(`  ${s.id} --> ${s.next}`);
        }
      }

      lines.push(
        'style CONNECT fill:#f8f9fa,stroke:#4f46e5,stroke-width:1.5px',
        'style STATE_PORTAL fill:#f8f9fa,stroke:#468c98,stroke-width:1.5px',
        classDef action   fill:#ffffff,stroke:#4f46e5,stroke-width:1.5px,color:#373f51
        classDef decision fill:#fff7ed,stroke:#f04f23,stroke-width:2px,color:#373f51
        'linkStyle default stroke:#616161,stroke-width:1.5px,opacity:0.9'
      );
      (data.steps || []).forEach(s => {
        const cls = s.type === 'decision' ? 'decision' : 'action';
        lines.push(`class ${s.id} ${cls}`);
      });

      return lines.join('\n');
    }

    async function main(){
      document.getElementById('src').textContent = yamlUrl;
      const res = await fetch(yamlUrl, { cache: 'no-store' });
      if(!res.ok) throw new Error(`Fetch failed (${res.status}) for ${yamlUrl}`);
      const raw = await res.text();
      let data;
      try { data = jsyaml.load(raw); }
      catch(e){ throw new Error('YAML parse error: ' + e.message); }

      document.title = toTitle(data);
      document.getElementById('title').textContent = toTitle(data);

      const mer = toMermaid(data);
      console.log(mer);
document.body.insertAdjacentHTML('beforeend', '<pre style="white-space:pre-wrap;margin:16px">'+
  mer.replace(/&/g,'&amp;').replace(/</g,'&lt;')+
'</pre>');

      const { svg } = await mermaid.render('diagram', mer);
      document.getElementById('chart').innerHTML = svg;
    }

    main().catch(err=>{
      const c = document.getElementById('chart');
      c.className = 'card error';
      c.textContent = 'Error loading diagram:\n' + err.message;
    });
  </script>
</body>
</html>
