<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>State Filing Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root { --ink:#373f51; --muted:#616161; --border:#e5e7eb; --card:#fff; }
    html,body{margin:0;padding:0}
    body{font-family: Tahoma, Arial, sans-serif; color:var(--ink); background:#fafafa}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:1.25rem;margin:0 0 12px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    #chart svg{width:100% !important;height:auto !important}
    .foot{margin-top:8px;color:var(--muted);font-size:.85rem}
    .error{color:#b00020;white-space:pre-wrap}
    a{color:#373f51;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">Filing Flow</h1>
    <div id="chart" class="card">Loadingâ€¦</div>
    <div class="foot">Source: <span id="src"></span></div>
  </div>

  <script>
    // --- Mermaid init with InsCipher brand + straight arrows ---
    mermaid.initialize({
      startOnLoad: false,
      theme: "base",
      flowchart: { useMaxWidth:true, curve:"linear", padding:12, htmlLabels:true },
      themeVariables: {
        fontFamily: 'Tahoma, Arial, sans-serif',
        primaryColor: '#ffffff',
        primaryTextColor: '#373f51',
        primaryBorderColor: '#ffffff',
        lineColor: '#616161',
        tertiaryColor: '#f04f23'
      }
    });

    // --- Helpers ---
    const qs = new URL(location.href).searchParams;
    const yamlUrl = qs.get('yaml') || './states/TX.yaml';

    function toTitle(data){
      const st = data && (data.state || data.State || 'State');
      return `${st} Filing Flow`;
    }

    // YAML -> Mermaid with lanes, edges, and brand styling
    function toMermaid(data) {
      const byLane = {};
      (data.steps || []).forEach(s => {
        const lane = s.lane || s.lane_key || 'default';
        (byLane[lane] ||= []).push(s);
      });
      const laneTitle = k => ({ connect:"InsCipher Connect", state_portal:"State Portal" }[k] || k);
      const dir = data.direction || 'LR'; // set TB in YAML for vertical
      const lines = [`flowchart ${dir}`];

      // Lanes & nodes
      for (const [lane, steps] of Object.entries(byLane)) {
        const laneId = lane.toUpperCase();
        lines.push(`  subgraph ${laneId}[${laneTitle(lane)}]`);
        for (const s of steps) {
          const label = (s.label || s.id).replace(/\[/g,'(').replace(/\]/g,')');
          const node = s.type === 'decision' ? `${s.id}{${label}}` : `${s.id}[${label}]`;
          lines.push(`    ${node}`);
        }
        lines.push('  end');
      }

      // Edges
      for (const s of (data.steps || [])) {
        if (s.type === 'decision') {
          if (s.yes_to) lines.push(`  ${s.id} -- Yes --> ${s.yes_to}`);
          if (s.no_to)  lines.push(`  ${s.id} -- No --> ${s.no_to}`);
        } else if (s.next) {
          lines.push(`  ${s.id} --> ${s.next}`);
        }
      }

      // === Neutral lane styling + branded nodes ===
      lines.push(
        'style CONNECT fill:#f8f9fa,stroke:#009ddc,stroke-width:1.5px',
        'style STATE_PORTAL fill:#f8f9fa,stroke:#468c98,stroke-width:1.5px',

        'classDef action   fill:#ffffff,stroke:#009ddc,stroke-width:1.5px,color:#373f51,font-family:Tahoma',
        'classDef decision fill:#fff7ed,stroke:#f04f23,stroke-width:2px,color:#373f51,font-family:Tahoma',

        'linkStyle default stroke:#616161,stroke-width:1.5px,opacity:0.9'
      );

      (data.steps || []).forEach(s => {
        const cls = s.type === 'decision' ? 'decision' : 'action';
        lines.push(`class ${s.id} ${cls}`);
      });

      return lines.join('\n');
    }

    async function main(){
      document.getElementById('src').textContent = yamlUrl;
      const res = await fetch(yamlUrl, { cache: 'no-store' });
      if(!res.ok) throw new Error(`Fetch failed (${res.status}) for ${yamlUrl}`);
      const raw = await res.text();

      let data;
      try { data = jsyaml.load(raw); }
      catch(e){ throw new Error('YAML parse error: ' + e.message); }

      document.title = toTitle(data);
      document.getElementById('title').textContent = toTitle(data);

      const mer = toMermaid(data);
      const { svg } = await mermaid.render('diagram', mer);
      document.getElementById('chart').innerHTML = svg;
    }

    main().catch(err=>{
      const c = document.getElementById('chart');
      c.className = 'card error';
      c.textContent = 'Error loading diagram:\n' + err.message + '\n\nCheck your YAML path & syntax.';
    });
  </script>
</body>
</html>
